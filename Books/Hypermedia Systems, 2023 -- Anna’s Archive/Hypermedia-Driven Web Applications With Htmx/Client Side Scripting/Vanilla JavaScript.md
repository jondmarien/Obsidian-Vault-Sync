# Vanilla JavaScript

> No code is faster than no code.
> 
> ℄ Merb (Ruby web framework), motto

Vanilla JavaScript is simply using plain JavaScript in your application, without any intermediate layers. The term “Vanilla” entered frontend web dev parlance as it became assumed that any sufficiently “advanced” web app would use some library with a name ending in “.js”. As JavaScript matured as a scripting language, however, standardized across browsers and provided more and more functionality, these frameworks and libraries became less important.

Somewhat ironically though, as JavaScript became more powerful and removed the need for the first generation of JavaScript libraries such as jQuery, it also enabled people to build complex SPA libraries. These SPA libraries are often even more elaborate than the original first generation of JavaScript libraries.

A quote from the website [http://vanilla-js.com](http://vanilla-js.com), which is well worth visiting even though it’s slightly out of date, captures the situation well:

> VanillaJS is the lowest-overhead, most comprehensive framework I’ve ever used.
> 
> ℄ http://vanilla-js.com

With JavaScript having matured as a scripting language, this is certainly the case for many applications. It is especially true in the case of HDAs, since, by using hypermedia, your application will not need many of the features typically provided by more elaborate Single Page Application JavaScript frameworks:

*   Client-side routing
    
*   An abstraction over DOM manipulation (i.e., templates that automatically update when referenced variables change)
    
*   Server side rendering [^1]
    
*   Attaching dynamic behavior to server-rendered tags on load (i.e., “hydration”)
    
*   Network requests
    

Without all this complexity being handled in JavaScript, your framework needs are dramatically reduced.

One of the best things about VanillaJS is how you install it: you don’t have to!

You can just start writing JavaScript in your web application, and it will simply work.

That’s the good news. The bad news is that, despite improvements over the last decade, JavaScript has some significant limitations as a scripting language that can make it less than ideal as a stand-alone scripting technology for Hypermedia-Driven Applications:

*   Being as established as it is, it has accreted a lot of features and warts.
    
*   It has a complicated and confusing set of features for working with asynchronous code.
    
*   Working with events is surprisingly difficult.
    
*   DOM APIs (a large portion of which were originally designed for Java, yes _Java_) are verbose and don’t have a habit of making common functionality easy to use.
    

None of these limitations are deal-breakers, of course. Many of them are gradually being fixed and many people prefer the “close to the metal” (for lack of a better term) nature of vanilla JavaScript over more elaborate client-side scripting approaches.

## A Simple Counter

To dive into vanilla JavaScript as a front end scripting option, let’s create a simple counter widget.

Counter widgets are a common “Hello World” example for JavaScript frameworks, so looking at how it can be done in vanilla JavaScript (as well as the other options we are going to look at) will be instructive.

Our counter widget will be very simple: it will have a number, shown as text, and a button that increments the number.

One problem with tackling this problem in vanilla JavaScript is that it lacks one thing that most JavaScript frameworks provide: a default code and architectural style.

With vanilla JavaScript, there are no rules!

This isn’t all bad. It presents a great opportunity to take a small journey through various styles that people have developed for writing their JavaScript.

### An inline implementation

To begin, let’s start with the simplest thing imaginable: all of our JavaScript will be written inline, directly in the HTML. When the button is clicked, we will look up the `output` element holding the number, and increment the number contained within it.

    <section class="counter">
      <output id="my-output">0output>  <1>
      <button
        onclick=" <2>
          document.querySelector('#my-output') <3>
            .textContent++ <4>
        "
      >Incrementbutton>
    section>

Counter in vanilla JavaScript, inline version

1.  Our output element has an ID to help us find it.
    
2.  We use the `onclick` attribute to add an event listener.
    
3.  Find the output via a querySelector() call.
    
4.  JavaScript allows us use the `++` operator on strings.
    

Not too bad.

It’s not the most beautiful code, and can be irritating especially if you aren’t used to the DOM APIs.

It’s a little annoying that we needed to add an `id` to the `output` element. The `document.querySelector()` function is a bit verbose compared with, say, the ` function, as provided by jQuery.

But it works. It’s also easy enough to understand, and crucially it doesn’t require any other JavaScript libraries.

So that’s the simple, inline approach with VanillaJS.

### Separating our scripting out

While the inline implementation is simple in some sense, a more standard way to write this would be to move the code into a separate JavaScript file. This JavaScript file would then either be linked to via a `</code> tag or placed into an inline <code><script></code> tag by a build process.</p> <p>Here we see the HTML and JavaScript <em>separated out</em> from one another, in different files. The HTML is now “cleaner” in that there is no JavaScript in it.</p> <p>The JavaScript is a bit more complex than in our inline version: we need to look up the button using a query selector and add an <em>event listener</em> to handle the click event and increment the counter.</p> <figure> <div class="sourceCode" id="cb125"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="dt"><</span><span class="kw">section</span><span class="ot"> class</span><span class="op">=</span><span class="st">"counter"</span><span class="dt">></span></span> <span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">output</span><span class="ot"> id</span><span class="op">=</span><span class="st">"my-output"</span><span class="dt">></span>0<span class="dt"></</span><span class="kw">output</span><span class="dt">></span></span> <span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">button</span><span class="ot"> class</span><span class="op">=</span><span class="st">"increment-btn"</span><span class="dt">></span>Increment<span class="dt"></</span><span class="kw">button</span><span class="dt">></span></span> <span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="dt"></</span><span class="kw">section</span><span class="dt">></span></span></code></pre></div> <figcaption><p>Counter HTML</p></figcaption> </figure> <figure> <div class="sourceCode" id="cb126"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> counterOutput <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"#my-output"</span>)<span class="op">,</span> <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a> incrementBtn <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">".counter .increment-btn"</span>) <span class="op"><</span><span class="dv">2</span><span class="op">></span></span> <span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span> <span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>incrementBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"click"</span><span class="op">,</span> e <span class="kw">=></span> { <span class="op"><</span><span class="dv">3</span><span class="op">></span></span> <span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a> counterOutput<span class="op">.</span><span class="at">innerHTML</span><span class="op">++</span> <span class="op"><</span><span class="dv">4</span><span class="op">></span></span> <span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div> <figcaption><p>Counter JavaScript</p></figcaption> </figure> <ol> <li><p>Find the output element.</p></li> <li><p>Find the button.</p></li> <li><p>We use <code>addEventListener</code>, which is preferable to <code>onclick</code> for many reasons.</p></li> <li><p>The logic stays the same, only the structure around it changes.</p></li> </ol> <p>In moving the JavaScript out to another file, we are following a software design principle known as <em>Separation of Concerns (SoC).</em></p> <p>Separation of Concerns posits that the various “concerns” (or aspects) of a software project should be divided up into multiple files, so that they don’t “pollute” one another. JavaScript isn’t markup, so it shouldn’t be in your HTML, it should be <em>elsewhere</em>. Styling information, similarly, isn’t markup, and so it belongs in a separate file as well (A CSS file, for example.)</p> <p>For quite some time, this Separation of Concerns was considered the “orthodox” way to build web applications.</p> <p>A stated goal of Separation of Concerns is that we should be able to modify and evolve each concern independently, with confidence that we won’t break any of the other concerns.</p> <p>However, let’s look at exactly how this principle has worked out in our simple counter example. If you look closely at the new HTML, it turns out that we’ve had to add a class to the button. We added this class so that we could look the button up in JavaScript and add in an event handler for the “click” event.</p> <p>Now, in both the HTML and the JavaScript, this class name is just a string and there isn’t any process to <em>verify</em> that the button has the right classes on it or its ancestors to ensure that the event handler is actually added to the right element.</p> <p>Unfortunately, it has turned out that the careless use of CSS selectors in JavaScript can cause what is known as <em>jQuery soup</em>. jQuery soup is a situation where:</p> <ul> <li><p>The JavaScript that attaches a given behavior to a given element is difficult to find.</p></li> <li><p>Code reuse is difficult.</p></li> <li><p>The code ends up wildly disorganized and “flat”, with lots of unrelated event handlers mixed together.</p></li> </ul> <p>The name “jQuery soup” comes from the fact that most JavaScript-heavy applications used to be built in jQuery (many still are), which, perhaps inadvertently, tended to encourage this style of JavaScript.</p> <p>So, you can see that the notion of Separation of Concerns doesn’t always work as well as promised: our concerns end up intertwined or coupled pretty deeply, even when we separate them into different files.</p> <figure> <div> <div data-align="start"> <pre><code> EXPECTATION REALITY HTML CSS JS HTML CSS JS ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐ │ │ │ │ │ │ │ │ │ │ │ │ │ C │ │ C │ │ c │ │ CO │ │ NC │ │ern │ │ O │ │ o │ │ o │ │ │ │ │ │ │ │ N │ │ n │ │ n │ │ Co │ │ nc │ │ERN │ │ C │ │ c │ │ c │ │ │ │ │ │ │ │ E │ │ e │ │ e │ │ co │ │ NC │ │ERN │ │ R │ │ r │ │ r │ │ │ │ │ │ │ │ N │ │ n │ │ n │ │ CO │ │ Nc │ │ern │ │ │ │ │ │ │ │ │ │ │ │ │ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ </code></pre> </div> </div> <figcaption><p>What concerns?</p></figcaption> </figure> <p>To show that it isn’t just naming between concerns that can get you into trouble, consider another small change to our HTML that demonstrates the problems with our separation of concerns: imagine that we decide to change the number field from an <code><output></code> tag to an <code><input type="number"></code>.</p> <p>This small change to our HTML will break our JavaScript, despite the fact we have “separated” our concerns.</p> <p>The fix for this issue is simple enough (we would need to change the <code>.textContent</code> property to <code>.value</code> property), but it demonstrates the burden of synchronizing markup changes and code changes across multiple files. Keeping everything in sync can become increasingly difficult as your application size increases.</p> <p>The fact that small changes to our HTML can break our scripting indicates that the two are <em>tightly coupled</em>, despite being broken up into multiple files. This tight coupling suggests that separation between HTML and JavaScript (and CSS) is often an illusory separation of concerns: the concerns are sufficiently related to one another that they aren’t easily separated.</p> <p>In Contact.app we are not <em>concerned</em> with “structure,” “styling” or “behavior”; we are concerned with collecting contact info and presenting it to users. SoC, in the way it’s formulated in web development orthodoxy, is not really an inviolate architectural guideline, but rather a stylistic choice that, as we can see, can even become a hindrance.</p> </section> <section id="locality-of-behavior" class="level5"> <h5>Locality of Behavior</h5> <p>It turns out that there is a burgeoning reaction <em>against</em> the Separation of Concerns design principle. Consider the following web technologies and techniques:</p> <ul> <li><p>JSX</p></li> <li><p>LitHTML</p></li> <li><p>CSS-in-JS</p></li> <li><p>Single-File Components</p></li> <li><p>Filesystem based routing</p></li> </ul> <p>Each of these technologies <em>colocate</em> code in various languages that address a single <em>feature</em> (typically a UI widget).</p> <p>All of them mix <em>implementation</em> concerns together in order to present a unified abstraction to the end-user. Separating technical detail concerns just isn’t as much of an, ahem, concern.</p> <p>Locality of Behavior (LoB) is an alternative software design principle that we coined, in opposition to Separation of Concerns. It describes the following characteristic of a piece of software:</p> <blockquote> <p>The behavior of a unit of code should be as obvious as possible by looking only at that unit of code.</p> <p>℄ https://htmx.org/essays/locality-of-behaviour/</p> </blockquote> <p>In simple terms: you should be able to tell what a button does by simply looking at the code or markup that creates that button. This does not mean you need to inline the entire implementation, but that you shouldn’t need to hunt for it or require prior knowledge of the codebase to find it.</p> <p>We will demonstrate Locality of Behavior in all of our examples, both the counter demos and the features we add to Contact.app. Locality of behavior is an explicit design goal of both _hyperscript and Alpine.js (which we will cover later) as well as htmx.</p> <p>All of these tools achieve Locality of Behavior by having you embed attributes directly within your HTML, as opposed to having code look up elements in a document through CSS selectors in order to add event listeners onto them.</p> <p>In a Hypermedia-Driven Application, we feel that the Locality of Behavior design principle is often more important than the more traditional Separation of Concerns design principle.</p> </section> <section id="what-to-do-with-our-counter" class="level5"> <h5>What to do with our counter?</h5> <p>So, should we go back to the <code>onclick</code> attribute way of doing things? That approach certainly wins in Locality of Behavior, and has the additional benefit that it is baked into HTML.</p> <p>Unfortunately, however, the <code>on*</code> JavaScript attributes also come with some drawbacks:</p> <ul> <li><p>They don’t support custom events.</p></li> <li><p>There is no good mechanism for associating long-lasting variables with an element — all variables are discarded when an event listener completes executing.</p></li> <li><p>If you have multiple instances of an element, you will need to repeat the listener code on each, or use something more clever like event delegation.</p></li> <li><p>JavaScript code that directly manipulates the DOM gets verbose, and clutters the markup.</p></li> <li><p>An element cannot listen for events on another element.</p></li> </ul> <p>Consider this common situation: you have a popup, and you want it to be dismissed when a user clicks outside of it. The listener will need to be on the body element in this situation, far away from the actual popup markup. This means that the body element would need to have listeners attached to it that deal with many unrelated components. Some of these components may not even be on the page when it was first rendered, if they are added dynamically after the initial HTML page is rendered.</p> <p>So vanilla JavaScript and Locality of Behavior don’t seem to mesh <em>quite</em> as well as we would like them to.</p> <p>The situation is not hopeless, however: it’s important to understand that LoB does not require behavior to be <em>implemented</em> at a use site, but merely <em>invoked</em> there. That is, we don’t need to write all our code on a given element, we just need to make it clear that a given element is <em>invoking</em> some code, which can be located elsewhere.</p> <p>Keeping this in mind, it <em>is</em> possible to improve LoB while writing JavaScript in a separate file, provided we have a reasonable system for structuring our JavaScript.</p> </section> </section> <section id="rsjs" class="level4"> <h4>RSJS</h4> <p>(the “Reasonable System for JavaScript Structure,” <a href="https://ricostacruz.com/rsjs/">https://ricostacruz.com/rsjs/</a>) is a set of guidelines for JavaScript architecture targeted at “a typical non-SPA website.” RSJS provides a solution to the lack of a standard code style for vanilla JavaScript that we mentioned earlier.</p> <p>Here are the RSJS guidelines most relevant for our counter widget:</p> <ul> <li><p>“Use <code>data-</code> attributes” in HTML: invoking behavior via adding data attributes makes it obvious there is JavaScript happening, as opposed to using random classes or IDs that may be mistakenly removed or changed.</p></li> <li><p>“One component per file”: the name of the file should match the data attribute so that it can be found easily, a win for LoB.</p></li> </ul> <p>To follow the RSJS guidelines, let’s restructure our current HTML and JavaScript files. First, we will use <em>data attributes</em>, that is, HTML attributes that begin with <code>data-</code>, a standard feature of HTML, to indicate that our HTML is a counter component. We will then update our JavaScript to use an attribute selector that looks for the <code>data-counter</code> attribute as the root element in our counter component and wires in the appropriate event handlers and logic. Additionally, let’s rework the code to use <code>querySelectorAll()</code> and add the counter functionality to <em>all</em> counter components found on the page. (You never know how many counters you might want!)</p> <p>Here is what our code looks like now:</p> <figure> <div class="sourceCode" id="cb128"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="dt"><</span><span class="kw">section</span><span class="ot"> class</span><span class="op">=</span><span class="st">"counter"</span><span class="ot"> data-counter</span><span class="dt">></span> <span class="er"><</span>1></span> <span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">output</span><span class="ot"> id</span><span class="op">=</span><span class="st">"my-output"</span><span class="ot"> data-counter-output</span><span class="dt">></span>0<span class="dt"></</span><span class="kw">output</span><span class="dt">></span> <span class="er"><</span>2></span> <span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">button</span><span class="ot"> class</span><span class="op">=</span><span class="st">"increment-btn"</span><span class="ot"> data-counter-increment</span><span class="dt">></span>Increment<span class="dt"></</span><span class="kw">button</span><span class="dt">></span></span> <span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="dt"></</span><span class="kw">section</span><span class="dt">></span></span></code></pre></div> <figcaption><p>Counter in vanilla JavaScript, with RSJS</p></figcaption> </figure> <ol> <li><p>Invoke a JavaScript behavior with a data attribute.</p></li> <li><p>Mark relevant descendant elements.</p></li> </ol> <figure> <div class="sourceCode" id="cb129"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">// counter.js <1></span></span> <span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">"[data-counter]"</span>) <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a> <span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=></span> {</span> <span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">const</span></span> <span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a> output <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"[data-counter-output]"</span>)<span class="op">,</span></span> <span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a> increment <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"[data-counter-increment]"</span>)<span class="op">;</span> <span class="op"><</span><span class="dv">3</span><span class="op">></span></span> <span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span> <span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a> increment<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"click"</span><span class="op">,</span> e <span class="kw">=></span> output<span class="op">.</span><span class="at">textContent</span><span class="op">++</span>)<span class="op">;</span> <span class="op"><</span><span class="dv">4</span><span class="op">></span></span> <span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a> })<span class="op">;</span></span></code></pre></div> </figure> <ol> <li><p>File should have the same name as the data attribute, so that we can locate it easily.</p></li> <li><p>Get all elements that invoke this behavior.</p></li> <li><p>Get any child elements we need.</p></li> <li><p>Register event handlers.</p></li> </ol> <p>Using RSJS solves, or at least alleviates, many of the problems we pointed out with our first, unstructured example of VanillaJS being split out to a separate file:</p> <ul> <li><p>The JS that attaches behavior to a given element is <em>clear</em> (though only through naming conventions).</p></li> <li><p>Reuse is <em>easy</em> — you can create another counter component on the page and it will just work.</p></li> <li><p>The code is <em>well-organized</em> — one behavior per file.</p></li> </ul> <p>All in all, RSJS is a good way to structure your vanilla JavaScript in a Hypermedia-Driven Application. So long as the JavaScript isn’t communicating with a server via a plain data JSON API, or holding a bunch of internal state outside of the DOM, this is perfectly compatible with the HDA approach.</p> <p>Let’s implement a feature in Contact.app using the RSJS/vanilla JavaScript approach.</p> </section> <section id="id__vanillajs_in_action_an_overflow_menu" class="level4"> <h4>VanillaJS in Action: An Overflow Menu</h4> <p>Our homepage has “Edit”, “View” and “Delete” links for every contact in our table. This uses a lot of space and creates visual clutter. Let’s fix that by placing these actions inside a drop-down menu with a button to open it.</p> <p>If you’re less familiar with JavaScript and the code here starts to feel too complicated, don’t worry; the Alpine.js and _hyperscript examples — which we’ll look at next — are easier to follow.</p> <p>Let’s begin by sketching the markup we want for our dropdown menu. First, we need an element, we’ll use a <code><div></code>, to enclose the entire widget and mark it as a menu component. Within this div, we will have a standard <code><button></code> that will function as the mechanism that shows and hides our menu items. Finally, we’ll have another <code><div></code> that holds the menu items that we are going to show.</p> <p>These menu items will be simple anchor tags, as they are in the current contacts table.</p> <p>Here is what our updated, RSJS-structured HTML looks like:</p> <figure> <div class="sourceCode" id="cb130"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="dt"><</span><span class="kw">div</span><span class="ot"> data-overflow-menu</span><span class="dt">></span> <span class="er"><</span>1></span> <span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">button</span><span class="ot"> type</span><span class="op">=</span><span class="st">"button"</span><span class="ot"> aria-haspopup</span><span class="op">=</span><span class="st">"menu"</span></span> <span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="ot"> aria-controls</span><span class="op">=</span><span class="st">"contact-menu-{{ contact.id }}"</span></span> <span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="ot"> </span><span class="dt">></span>Options<span class="dt"></</span><span class="kw">button</span><span class="dt">></span> <span class="er"><</span>2></span> <span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">div</span><span class="ot"> role</span><span class="op">=</span><span class="st">"menu"</span><span class="ot"> hidden id</span><span class="op">=</span><span class="st">"contact-menu-{{ contact.id }}"</span><span class="dt">></span> <span class="er"><</span>3></span> <span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">a</span><span class="ot"> role</span><span class="op">=</span><span class="st">"menuitem"</span></span> <span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="ot"> href</span><span class="op">=</span><span class="st">"/contacts/{{ contact.id }}/edit"</span><span class="dt">></span>Edit<span class="dt"></</span><span class="kw">a</span><span class="dt">></span> <span class="er"><</span>4></span> <span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a> <span class="dt"><</span><span class="kw">a</span><span class="ot"> role</span><span class="op">=</span><span class="st">"menuitem"</span><span class="ot"> href</span><span class="op">=</span><span class="st">"/contacts/{{ contact.id }}"</span><span class="dt">></span>View<span class="dt"></</span><span class="kw">a</span><span class="dt">></span></span> <span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a> <span class="co"><!-- ... --></span></span> <span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a> <span class="dt"></</span><span class="kw">div</span><span class="dt">></span></span> <span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="dt"></</span><span class="kw">div</span><span class="dt">></span></span></code></pre></div> </figure> <ol> <li><p>Mark the root element of the menu component</p></li> <li><p>This button will open and close our menu</p></li> <li><p>A container for our menu items</p></li> <li><p>Menu items</p></li> </ol> <p>The roles and ARIA attributes are based on the Menu and Menu Button patterns from the ARIA Authoring Practices Guide.</p> <div id="sidebar"> <div> <p><strong>What is ARIA?</strong></p> <div> <p>As we web developers create more interactive, app-like websites, HTML’s repertoire of elements won’t have all we need. As we have seen, using CSS and JavaScript, we can endow existing elements with extended behavior and appearances, rivaling those of native controls.</p> <p>However, there was one thing web apps couldn’t replicate. While these widgets may <em>look</em> similar enough to the real deal, assistive technology (e.g., screen readers) could only deal with the underlying HTML elements.</p> <p>Even if you take the time to get all the keyboard interactions right, some users often are unable to work with these custom elements easily.</p> <p>ARIA was created by W3C’s Web Accessibility Initiative (WAI) in 2008 to address this problem. At a surface level, it is a set of attributes you can add to HTML to make it meaningful to assistive software such as a screen reader.</p> <p>ARIA has two main components that interact with one another:</p> <p>The first is the <code>role</code> attribute. This attribute has a predefined set of possible values: <code>menu, dialog, radiogroup</code> etc. The <code>role</code> attribute <em>does not add any behavior</em> to HTML elements. Rather, it is a promise you make to the user. When you annotate an element as <code>role='menu'</code>, you are saying: <em>I will make this element work like a menu.</em></p> <p>If you add a <code>role</code> to an element but you <em>don’t</em> uphold the promise, the experience for many users will be <em>worse</em> than if the element had no <code>role</code> at all. Thus, it is written:</p> <blockquote> <p>No ARIA is better than Bad ARIA.</p> <p>℄ W3C, Read Me First | APG, https://www.w3.org/WAI/ARIA/apg/practices/read-me-first/</p> </blockquote> <p>The second component of ARIA is the <em>states and properties</em>, all sharing the <code>aria-</code> prefix: <code>aria-expanded, aria-controls, aria-label</code> etc. These attributes can specify various things such as the state of a widget, the relationships between components, or additional semantics. Once again, these attributes are <em>promises</em>, not implementations.</p> <p>Rather than learn all the roles and attributes and try to combine them into a usable widget, the best course of action for most developers is to rely on the ARIA Authoring Practices Guide (APG), a web resource with practical information aimed directly at web developers.</p> <p>If you’re new to ARIA, check out the following W3C resources:</p> <ul> <li><p>ARIA: Read Me First: <a href="https://www.w3.org/WAI/ARIA/apg/practices/read-me-first/">https://www.w3.org/WAI/ARIA/apg/practices/read-me-first/</a></p></li> <li><p>ARIA UI patterns: <a href="https://www.w3.org/WAI/ARIA/apg/patterns/">https://www.w3.org/WAI/ARIA/apg/patterns/</a></p></li> <li><p>ARIA Good Practices: <a href="https://www.w3.org/WAI/ARIA/apg/practices/">https://www.w3.org/WAI/ARIA/apg/practices/</a></p></li> </ul> <p>Always remember to <strong>test</strong> your website for accessibility to ensure all users can interact with it easily and effectively.</p> </div> </div> </div> <p>On the JS side of our implementation, we’ll begin with the RSJS boilerplate: query for all elements with some data attribute, iterate over them, get any relevant descendants.</p> <p>Note that, below, we’ve modified the RSJS boilerplate a bit to integrate with htmx; we load the overflow menu when htmx loads new content.</p> <figure> <div class="sourceCode" id="cb131"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">overflowMenu</span>(tree <span class="op">=</span> <span class="bu">document</span>) {</span> <span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a> tree<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">"[data-overflow-menu]"</span>)<span class="op">.</span><span class="fu">forEach</span>(menuRoot <span class="kw">=></span> { <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">const</span></span> <span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a> button <span class="op">=</span> menuRoot<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"[aria-haspopup]"</span>)<span class="op">,</span> <span class="op"><</span><span class="dv">2</span><span class="op">></span></span> <span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a> menu <span class="op">=</span> menuRoot<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">"[role=menu]"</span>)<span class="op">,</span> <span class="op"><</span><span class="dv">3</span><span class="op">></span></span> <span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a> items <span class="op">=</span> [<span class="op">...</span>menu<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">"[role=menuitem]"</span>)]<span class="op">;</span></span> <span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a> })<span class="op">;</span></span> <span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>}</span> <span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a></span> <span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="fu">addEventListener</span>(<span class="st">"htmx:load"</span><span class="op">,</span> e <span class="kw">=></span> <span class="fu">overflowMenu</span>(e<span class="op">.</span><span class="at">target</span>))<span class="op">;</span> <span class="op"><</span><span class="dv">4</span><span class="op">></span></span></code></pre></div> </figure> <ol> <li><p>With RSJS, you’ll be writing <code>document.querySelectorAll(…​).forEach</code> a lot.</p></li> <li><p>To keep the HTML clean, we use ARIA attributes rather than custom data attributes here.</p></li> <li><p>Use the spread operator to convert a <code>NodeList</code> into a normal <code>Array</code>.</p></li> <li><p>Initialize all overflow menus when the page is loaded or content is inserted by htmx.</p></li> </ol> <p>Conventionally, we would keep track of whether the menu is open using a JavaScript variable or a property in a JavaScript state object. This approach is common in large, JavaScript-heavy web applications.</p> <p>However, this approach has some drawback:</p> <ul> <li><p>We would need to keep the DOM in sync with the state (harder without a framework).</p></li> <li><p>We would lose the ability to serialize the HTML (as this open state isn’t stored in the DOM, but rather in JavaScript).</p></li> </ul> <p>Instead of taking this approach, we will use the DOM to store our state. We’ll lean on the <code>hidden</code> attribute on the menu element to tell us it’s closed. If the HTML of the page is snapshotted and restored, the menu can be restored as well by simply re-running the JS.</p> <figure> <div class="sourceCode" id="cb132"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> [<span class="op">...</span>menu<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">"[role=menuitem]"</span>)]<span class="op">;</span> <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a></span> <span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> isOpen <span class="op">=</span> () <span class="kw">=></span> <span class="op">!</span>menu<span class="op">.</span><span class="at">hidden</span><span class="op">;</span> <span class="op"><</span><span class="dv">2</span><span class="op">></span></span></code></pre></div> </figure> <ol> <li><p>We get the list of menu items at the start. This implementation will not support dynamically adding or removing menu items.</p></li> <li><p>The <code>hidden</code> attribute is helpfully reflected as a <code>hidden</code> <em>property</em>, so we don’t need to use <code>getAttribute</code>.</p></li> </ol> <p>We’ll also make the menu items non-tabbable, so we can manage their focus ourselves.</p> <figure> <div class="sourceCode" id="cb133"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>items<span class="op">.</span><span class="fu">forEach</span>(item <span class="kw">=></span> item<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">"tabindex"</span><span class="op">,</span> <span class="st">"-1"</span>))<span class="op">;</span></span></code></pre></div> </figure> <p>Now let’s implement toggling the menu in JavaScript:</p> <figure> <div class="sourceCode" id="cb134"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toggleMenu</span>(open <span class="op">=</span> <span class="op">!</span><span class="fu">isOpen</span>()) { <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (open) {</span> <span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a> menu<span class="op">.</span><span class="at">hidden</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span> <span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a> button<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">"aria-expanded"</span><span class="op">,</span> <span class="st">"true"</span>)<span class="op">;</span></span> <span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a> items[<span class="dv">0</span>]<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">2</span><span class="op">></span></span> <span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> {</span> <span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a> menu<span class="op">.</span><span class="at">hidden</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span> <span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a> button<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">"aria-expanded"</span><span class="op">,</span> <span class="st">"false"</span>)<span class="op">;</span></span> <span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a> }</span> <span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>}</span> <span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a></span> <span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="fu">toggleMenu</span>(<span class="fu">isOpen</span>())<span class="op">;</span> <span class="op"><</span><span class="dv">3</span><span class="op">></span></span> <span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>button<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"click"</span><span class="op">,</span> () <span class="kw">=></span> <span class="fu">toggleMenu</span>())<span class="op">;</span> <span class="op"><</span><span class="dv">4</span><span class="op">></span></span> <span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>menuRoot<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"blur"</span><span class="op">,</span> e <span class="kw">=></span> <span class="fu">toggleMenu</span>(<span class="kw">false</span>))<span class="op">;</span> <span class="op"><</span><span class="dv">5</span><span class="op">></span></span></code></pre></div> </figure> <ol> <li><p>Optional parameter to specify desired state. This allows us to use one function to open, close, or toggle the menu.</p></li> <li><p>Focus first item of menu when opened.</p></li> <li><p>Call <code>toggleMenu</code> with current state, to initialize element attributes.</p></li> <li><p>Toggle menu when button is clicked.</p></li> <li><p>Close menu when focus moves away.</p></li> </ol> <p>Let’s also make the menu close when we click outside it, a nice behavior that mimics how native drop-down menus work. This will require an event listener on the whole window.</p> <p>Note that we need to be careful with this kind of listener: you may find that listeners accumulate as components add listeners and fail to remove them when the component is removed from the DOM. This, unfortunately, leads to difficult to track down memory leaks.</p> <p>There is not an easy way in JavaScript to execute logic when an element is removed. The best option is what is known as the <code>MutationObserver</code> API. A <code>MutationObserver</code> is very useful, but the API is quite heavy and a bit arcane, so we won’t be using it for our example.</p> <p>Instead, we will use a simple pattern to avoid leaking event listeners: when our event listener runs, we will check if the attaching component is still in the DOM, and, if the element is no longer in the DOM, we will remove the listener and exit.</p> <p>This is a somewhat hacky, manual form of <em>garbage collection</em>. As is (usually) the case with other garbage collection algorithms, our strategy removes listeners in a nondeterministic amount of time after they are no longer needed. Fortunately for us, With a frequent event like “the user clicks anywhere in the page” driving the collection, it should work well enough for our system.</p> <figure> <div class="sourceCode" id="cb135"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"click"</span><span class="op">,</span> <span class="kw">function</span> <span class="fu">clickAway</span>(<span class="bu">event</span>) {</span> <span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="op">!</span>menuRoot<span class="op">.</span><span class="at">isConnected</span>)</span> <span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a> <span class="bu">window</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">"click"</span><span class="op">,</span> clickAway)<span class="op">;</span> <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="op">!</span>menuRoot<span class="op">.</span><span class="fu">contains</span>(<span class="bu">event</span><span class="op">.</span><span class="at">target</span>)) <span class="fu">toggleMenu</span>(<span class="kw">false</span>)<span class="op">;</span> <span class="op"><</span><span class="dv">2</span><span class="op">></span></span> <span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div> </figure> <ol> <li><p>This line is the garbage collection.</p></li> <li><p>If the click is outside the menu, close the menu.</p></li> </ol> <p>Now, let’s move on to the keyboard interactions for our dropdown menu. The keyboard handlers turn out to all be pretty similar to one another and not particularly intricate, so let’s knock them all out in one go:</p> <figure> <div class="sourceCode" id="cb136"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> currentIndex <span class="op">=</span> () <span class="kw">=></span> { <span class="op"><</span><span class="dv">1</span><span class="op">></span></span> <span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">const</span> idx <span class="op">=</span> items<span class="op">.</span><span class="fu">indexOf</span>(<span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span>)<span class="op">;</span></span> <span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (idx <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span> <span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">return</span> idx<span class="op">;</span></span> <span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>}</span> <span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a></span> <span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>menu<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"keydown"</span><span class="op">,</span> e <span class="kw">=></span> {</span> <span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"ArrowUp"</span>) {</span> <span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a> items[<span class="fu">currentIndex</span>() <span class="op">-</span> <span class="dv">1</span>]<span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">2</span><span class="op">></span></span> <span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a></span> <span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"ArrowDown"</span>) {</span> <span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a> items[<span class="fu">currentIndex</span>() <span class="op">+</span> <span class="dv">1</span>]<span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">3</span><span class="op">></span></span> <span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a></span> <span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"Space"</span>) {</span> <span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a> items[<span class="fu">currentIndex</span>()]<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">4</span><span class="op">></span></span> <span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a></span> <span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"Home"</span>) {</span> <span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a> items[<span class="dv">0</span>]<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">5</span><span class="op">></span></span> <span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a></span> <span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"End"</span>) {</span> <span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a> items[items<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">6</span><span class="op">></span></span> <span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a></span> <span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">"Escape"</span>) {</span> <span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a> <span class="fu">toggleMenu</span>(<span class="kw">false</span>)<span class="op">;</span> <span class="op"><</span><span class="dv">7</span><span class="op">></span></span> <span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a> button<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span> <span class="op"><</span><span class="dv">8</span><span class="op">></span></span> <span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a> }</span> <span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div> </figure> <ol> <li><p>Helper: Get the index in the items array of the currently focused menu item (0 if none).</p></li> <li><p>Move focus to the previous menu item when the up arrow key is pressed.</p></li> <li><p>Move focus to the next menu item when the down arrow key is pressed.</p></li> <li><p>Activate the currently focused element when the space key is pressed.</p></li> <li><p>Move focus to the first menu item when Home is pressed.</p></li> <li><p>Move focus to the last menu item when End is pressed.</p></li> <li><p>Close menu when Escape is pressed.</p></li> <li><p>Return focus to menu button when closing menu.</p></li> </ol> <p>That should cover all our bases, and we’ll admit that’s a lot of code. But, in fairness, it’s code that encodes a lot of behavior.</p> <p>Now, our drop-down menu isn’t perfect, and it doesn’t handle a lot of things. For example, we don’t support submenus, or menu items being added or removed dynamically to the menu. If we needed more menu features like this, it might make more sense to use an off-the-shelf library, such as GitHub’s <a href="https://github.com/github/details-menu-element"><code>details-menu-element</code></a>.</p> <p>But, for our relatively simple use case, vanilla JavaScript does a fine job, and we got to explore ARIA and RSJS while implementing it.</p> </section> </section> </x-turndown>`